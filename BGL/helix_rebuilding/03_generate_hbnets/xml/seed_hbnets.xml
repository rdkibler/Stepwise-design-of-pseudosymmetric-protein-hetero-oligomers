

<ROSETTASCRIPTS>
    ##RUN WITH: /home/bcov/ppi/builds/19-08-28/main/source/cmake/build_release_omp_hdf5/rosetta_scripts -holes:dalphaball /home/bcov/ppi/tutorial_build/main/source/external/DAlpahBall/DAlphaBall.gcc -indexed_structure_store:fragment_store /home/brunette/DBs/hdf5/ss_grouped_vall_helix_shortLoop.h5 -corrections::beta_nov16 true 

    <SCOREFXNS>
        <ScoreFunction name="sfxn" weights="beta_nov16" />
    </SCOREFXNS>

    <RESIDUE_SELECTORS>
        <True name="all"/>
        <Chain name="chainA" chains="A"/> #local
        <Chain name="chainB" chains="B"/> #local



        <SSElement name="interface_chA" selection="-3,H,M" to_selection="c_term" chain="A" />
        <SSElement name="interface_chB" selection="n_term" to_selection="3,H,M" chain="B" />



        <Or name="AB_interface" selectors="interface_chA,interface_chB" />
        <Not name="Not_interface" selector="AB_interface" />



        <ResidueName name="pro_and_gly_positions" residue_name3="PRO,GLY" />
        <ResidueName name="apolar" residue_name3="ALA,CYS,PHE,ILE,LEU,MET,THR,PRO,VAL,TRP,TYR" />
        <Not name="polar" selector="apolar" />


        InterfaceByVector name="hbnet_seed" cb_dist_cut="11" nearby_atom_cut="5.5" vector_angle_cut="75" vector_dist_cut="9" grp1_selector="interface_chA" grp2_selector="interface_chB"/>


        <Or name="design_selector" selectors="AB_interface"/>
        <Not name="not_design_selector" selector="design_selector"/>
        <Neighborhood name="pack_selector" selector="design_selector" distance="8.0" include_focus_in_subset="0"/>
        <Not name="not_pack_selector" selector="pack_selector"/>
        <And name="lock_selector" selectors="not_pack_selector,not_design_selector"/>

        

        <Layer name="surface" select_core="false" select_boundary="false" select_surface="true" use_sidechain_neighbors="false" core_cutoff="20" surface_cutoff="35" ball_radius="2.5"/>
        <Layer name="deep_bdry" select_core="false" select_boundary="true" select_surface="false" use_sidechain_neighbors="false" core_cutoff="6" surface_cutoff="35" ball_radius="2.5"/>
        <Layer name="boundary" select_core="false" select_boundary="true" select_surface="false" use_sidechain_neighbors="false" core_cutoff="20" surface_cutoff="35" ball_radius="2.5"/>
        <Layer name="core" select_core="true" select_boundary="false" select_surface="false" use_sidechain_neighbors="false" core_cutoff="20" surface_cutoff="35" ball_radius="2.5"/>
        <Layer name="deep_core" select_core="true" select_boundary="false" select_surface="false" use_sidechain_neighbors="false" core_cutoff="6" surface_cutoff="35" ball_radius="2.5"/>



        <SecondaryStructure name="sheet" overlap="0" minH="3" minE="2" include_terminal_loops="false" use_dssp="true" ss="E"/>
        <SecondaryStructure name="entire_loop" overlap="0" minH="3" minE="2" include_terminal_loops="true" use_dssp="true" ss="L"/>
        <SecondaryStructure name="entire_helix" overlap="0" minH="3" minE="2" include_terminal_loops="false" use_dssp="true" ss="H"/>
        <And name="helix_cap" selectors="entire_loop">
            <PrimarySequenceNeighborhood lower="1" upper="0" selector="entire_helix"/>
        </And>
        <And name="helix_start" selectors="entire_helix">
            <PrimarySequenceNeighborhood lower="0" upper="1" selector="helix_cap"/>
        </And>
        <And name="helix" selectors="entire_helix">
            <Not selector="helix_start"/>
        </And>
        <And name="loop" selectors="entire_loop">
            <Not selector="helix_cap"/>
        </And>

        <PrimarySequenceNeighborhood name="for_struct" lower="1" upper="1" selector="entire_loop"/>

    </RESIDUE_SELECTORS>

    <TASKOPERATIONS>     
        <PruneBuriedUnsats name="prune_buried_unsats" allow_even_trades="false" atomic_depth_cutoff="3.5" minimum_hbond_energy="-1.0"/>
        <OperateOnResidueSubset name="pack" selector="pack_selector" >
            <RestrictToRepackingRLT/> 
        </OperateOnResidueSubset>

        <OperateOnResidueSubset name="lock" selector="lock_selector" >
            <PreventRepackingRLT/> 
        </OperateOnResidueSubset>


        <DesignRestrictions name="hbnet_layer_design">
            <Action selector_logic="surface" aas=  "RHKDESTNQ"/>
            <Action selector_logic="boundary" aas="RHKDESTNQWY"/>
            <Action selector_logic="core" aas="HSTNQWY"/>
        </DesignRestrictions>


        <IncludeCurrent name="current" />
        <LimitAromaChi2 name="limitchi2" chi2max="110" chi2min="70" include_trp="True" />
        <ExtraRotamersGeneric name="ex1_ex2" ex1="1" ex2="1" />

    	<OperateOnResidueSubset name="restrict_PRO_GLY" selector="pro_and_gly_positions">
    		<PreventRepackingRLT/>
    	</OperateOnResidueSubset>

    </TASKOPERATIONS>

    <SIMPLE_METRICS>
	<SelectedResiduesPyMOLMetric name="selected_designable" custom_type="design_selector" residue_selector="design_selector" />
	<SelectedResiduesPyMOLMetric name="selected_pack" custom_type="pack" residue_selector="pack_selector" />
	<SelectedResiduesPyMOLMetric name="selected_lock" custom_type="lock" residue_selector="lock_selector" />
	<SelectedResiduesPyMOLMetric name="deep_core" custom_type="deep_core" residue_selector="deep_core"/>
	<SelectedResiduesPyMOLMetric name="deep_bdry" custom_type="deep_bdry" residue_selector="deep_bdry"/>
	<SelectedResiduesPyMOLMetric name="core" custom_type="core" residue_selector="core"/>
	<SelectedResiduesPyMOLMetric name="boundary" custom_type="boundary" residue_selector="boundary"/>
	<SelectedResiduesPyMOLMetric name="surface" custom_type="surface" residue_selector="surface"/>

    </SIMPLE_METRICS>




    <MOVERS>
	<RunSimpleMetrics name="report_selectors" metrics="selected_designable,selected_pack,selected_lock,core,deep_core,boundary,deep_bdry,surface"/>
        <SwitchChainOrder name="cutB" chain_order="1" />
        <SwitchChainOrder name="cutA" chain_order="2" />
    </MOVERS>



    <FILTERS>
        <BuriedUnsatHbonds name="sbuns5.5_heavy_ball_1.1D" use_reporter_behavior="true" report_all_heavy_atom_unsats="true" scorefxn="sfxn" ignore_surface_res="false" print_out_info_to_pdb="true" confidence="0" use_ddG_style="true" burial_cutoff="0.01" dalphaball_sasa="true" probe_radius="1.1" atomic_depth_selection="5.5" atomic_depth_deeper_than="false" burial_cutoff_apo="0.2" atomic_depth_resolution="0.49" max_hbond_energy="1.5"/>
        <BuriedUnsatHbonds name="vbuns5.5_heavy_ball_1.1D" use_reporter_behavior="true" report_all_heavy_atom_unsats="true" scorefxn="sfxn"  ignore_surface_res="false" print_out_info_to_pdb="true" confidence="0" use_ddG_style="true" dalphaball_sasa="true" probe_radius="1.1" atomic_depth_selection="5.5" burial_cutoff="1000" burial_cutoff_apo="0.2" atomic_depth_apo_surface="5.5" atomic_depth_resolution="0.49" max_hbond_energy="1.5"/>
        <SSPrediction name="mismatch_probability" confidence="0" cmd="/software/psipred4/runpsipred_single" use_probability="1" mismatch_probability="1" use_svm="0" />
        <MoveBeforeFilter name="psipred_A" mover="cutB" filter="mismatch_probability" confidence="0"/>
        <MoveBeforeFilter name="psipred_B" mover="cutA" filter="mismatch_probability" confidence="0"/>
        
    </FILTERS>


    <MOVERS>
	
       

        <ScoreMover name="score!" scorefxn="sfxn"/>
        
	### parameters to play with
	#   hbnet_threshold () this is the most important factor. too positive and i'll get too many results (super redundant) but too negative and it'll throw everything away. So i guess mostly it's for controling redundancy. 
	#   upper_score_limit (). can help weed out anything terrible
	#   

    #note! HBNet is incapable of finding only 2 residue networks. Find only 3 residue networks and look for networks with at least 1 core residue in each chain. 
	
	<HBNetStapleInterface 
            scorefxn="sfxn" 
            name="place_hbnet_seed" 
            hb_threshold="-0.6" 
            secondary_search="false"
            min_helices_contacted_by_network="2" 
            core_selector="core" 
            show_task="1" 
            store_subnetworks="1" 
            verbose="0" 
            no_heavy_unsats_allowed="1" 
            write_network_pdbs="0" 
            min_network_size="4" 
            max_unsat_Hpol="0"
            min_percent_hbond_capacity="0.62"
            min_intermolecular_hbonds="2"
            min_core_res="4" 
            min_unique_networks="1"
            max_networks_per_pose="3" 
            write_cst_files="0" 
            use_aa_dependent_weights="true" 
            max_replicates_before_branch="1"
            monte_carlo="true" 
            seed_hbond_threshold="-0.4"
            monte_carlo_seed_must_be_buried="1"
            total_num_mc_runs="10000" 
            task_operations="limitchi2,ex1_ex2,pack,lock,hbnet_layer_design" />



<MultiplePoseMover name="MPM_filter" max_input_poses="9999">
        <ROSETTASCRIPTS>
          <RESIDUE_SELECTORS>
            <Chain name="chainA" chains="A"/>
            <Chain name="chainB" chains="B"/>
            <ResiduePDBInfoHasLabel name="hbnet_resis" property="HBNet"/>
            <Layer name="surface" select_core="false" select_boundary="false" select_surface="true" use_sidechain_neighbors="false" core_cutoff="20" surface_cutoff="35" ball_radius="2.5"/>
            <Layer name="boundary" select_core="false" select_boundary="true" select_surface="false" use_sidechain_neighbors="false" core_cutoff="20" surface_cutoff="35" ball_radius="2.5"/>
            <Layer name="core" select_core="true" select_boundary="false" select_surface="false" use_sidechain_neighbors="false" core_cutoff="20" surface_cutoff="35" ball_radius="2.5"/>
            <Layer name="deep_core" select_core="true" select_boundary="false" select_surface="false" use_sidechain_neighbors="false" core_cutoff="6" surface_cutoff="35" ball_radius="2.5"/>
	    <And name="buried_hbnet" selectors="core,hbnet_resis"/>

            <And name="chainA_core_hbnet_resis" selectors="chainA,hbnet_resis,core"/>
            <And name="chainB_core_hbnet_resis" selectors="chainB,hbnet_resis,core"/>
          </RESIDUE_SELECTORS>
          <FILTERS>
            <ResidueCount name="spanning_core_hbnets_A" min_residue_count="1" residue_selector="chainA_core_hbnet_resis" confidence="1"/>
            <ResidueCount name="spanning_core_hbnets_B" min_residue_count="1" residue_selector="chainB_core_hbnet_resis" confidence="1"/>
          </FILTERS>
	  <MOVERS>
		<AddResidueLabel name="label_buried_hbnets" residue_selector="buried_hbnet" label="buried_HBNet"/>
	  </MOVERS>
          <PROTOCOLS>
            #throw away things which are not acutally buried
            <Add filter="spanning_core_hbnets_A"/>
            <Add filter="spanning_core_hbnets_B"/>
	    <Add mover="label_buried_hbnets"/>
          </PROTOCOLS>
        </ROSETTASCRIPTS>
      </MultiplePoseMover>



    </MOVERS>

    <APPLY_TO_POSE>
    </APPLY_TO_POSE>
    <PROTOCOLS>
	<Add mover="score!"/>
	<Add mover="report_selectors"/>
<Add mover="place_hbnet_seed"/>
<Add mover="MPM_filter"/>
    </PROTOCOLS>
    <OUTPUT />
</ROSETTASCRIPTS>
